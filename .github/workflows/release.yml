name: Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v* æ ¼å¼çš„ tag æ—¶è§¦å‘ï¼ˆå¦‚ v0.1.0ï¼‰

permissions:
  contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  build-and-release:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Build CLI tool
        run: |
          make scanner
          # æ‰“åŒ…å‘½ä»¤è¡Œå·¥å…·
          tar -czf mac-file-search-${{ steps.version.outputs.VERSION }}-darwin-arm64.tar.gz mac-file-search
          # å¦‚æœéœ€è¦ x86_64 ç‰ˆæœ¬
          GOARCH=amd64 go build -o mac-file-search-amd64 main.go
          tar -czf mac-file-search-${{ steps.version.outputs.VERSION }}-darwin-amd64.tar.gz mac-file-search-amd64

      - name: Build GUI App
        run: |
          cd mac-search-app
          # æ­£å¸¸æ„å»ºï¼ˆåŒ…å«å‰ç«¯ç¼–è¯‘å’ŒåµŒå…¥ï¼‰
          wails build
          cd ..

          # ç§»é™¤éš”ç¦»å±æ€§ï¼Œé¿å… macOS Gatekeeper é˜»æ­¢
          xattr -cr "mac-search-app/build/bin/Macæ–‡ä»¶æœç´¢.app"

          # å‡†å¤‡æ‰“åŒ…ç›®å½•ï¼ˆåŒ…å« app + install.commandï¼‰
          mkdir -p package-temp
          cp -r "mac-search-app/build/bin/Macæ–‡ä»¶æœç´¢.app" package-temp/
          cp install.command package-temp/
          chmod +x package-temp/install.command

          # æ‰“åŒ…ä¸º ZIPï¼ˆä½¿ç”¨ ditto ä¿ç•™æƒé™ï¼‰
          cd package-temp
          ditto -c -k . "../mac-file-search-${{ steps.version.outputs.VERSION }}-app.zip"
          cd ..
          rm -rf package-temp

      - name: Generate checksums
        run: |
          shasum -a 256 mac-file-search-${{ steps.version.outputs.VERSION }}-*.tar.gz > checksums.txt
          shasum -a 256 mac-file-search-${{ steps.version.outputs.VERSION }}-*.zip >> checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            mac-file-search-${{ steps.version.outputs.VERSION }}-darwin-arm64.tar.gz
            mac-file-search-${{ steps.version.outputs.VERSION }}-darwin-amd64.tar.gz
            mac-file-search-${{ steps.version.outputs.VERSION }}-app.zip
            checksums.txt
          body: |
            ## ğŸ‰ Mac File Search ${{ steps.version.outputs.VERSION }}

            ### âš¡ ä¸‹è½½

            #### GUI åº”ç”¨ï¼ˆæ¨èï¼‰
            - [Macæ–‡ä»¶æœç´¢.app (Universal)](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/mac-file-search-${{ steps.version.outputs.VERSION }}-app.zip) - å›¾å½¢ç•Œé¢åº”ç”¨

            #### å‘½ä»¤è¡Œå·¥å…·
            - [mac-file-search (ARM64)](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/mac-file-search-${{ steps.version.outputs.VERSION }}-darwin-arm64.tar.gz) - Apple Silicon (M1/M2/M3)
            - [mac-file-search (AMD64)](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/mac-file-search-${{ steps.version.outputs.VERSION }}-darwin-amd64.tar.gz) - Intel èŠ¯ç‰‡

            ### ğŸ“ å®‰è£…è¯´æ˜

            #### GUI åº”ç”¨

            **ğŸ‰ è¶…ç®€å•ï¼šè§£å‹ååŒå‡» `install.command` å³å¯ï¼**

            ZIP åŒ…ä¸­åŒ…å«ï¼š
            - `Macæ–‡ä»¶æœç´¢.app` - åº”ç”¨ç¨‹åº
            - `install.command` - è‡ªåŠ¨å®‰è£…è„šæœ¬ï¼ˆåŒå‡»è¿è¡Œï¼‰

            **æ­¥éª¤ï¼š**
            1. ä¸‹è½½å¹¶è§£å‹ `mac-file-search-${{ steps.version.outputs.VERSION }}-app.zip`
            2. **åŒå‡» `install.command`** æ–‡ä»¶
            3. è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
               - âœ… ç§»é™¤ Gatekeeper éš”ç¦»å±æ€§
               - âœ… å®‰è£…åˆ°ã€Œåº”ç”¨ç¨‹åºã€æ–‡ä»¶å¤¹
            4. ä»ã€Œå¯åŠ¨å°ã€æ‰“å¼€ã€ŒMacæ–‡ä»¶æœç´¢ã€å³å¯ä½¿ç”¨

            **æ‰‹åŠ¨å®‰è£…ï¼ˆå¯é€‰ï¼‰ï¼š**
            ```bash
            xattr -cr "Macæ–‡ä»¶æœç´¢.app"
            mv "Macæ–‡ä»¶æœç´¢.app" /Applications/
            ```

            #### å‘½ä»¤è¡Œå·¥å…·
            ```bash
            # ä¸‹è½½å¹¶è§£å‹
            tar -xzf mac-file-search-*-darwin-*.tar.gz

            # ç§»åŠ¨åˆ°ç³»ç»Ÿè·¯å¾„
            sudo mv mac-file-search /usr/local/bin/

            # éªŒè¯å®‰è£…
            mac-file-search --help
            ```

            ### âœ¨ ä¸»è¦åŠŸèƒ½
            - âš¡ æé€Ÿæ‰«æï¼š2åˆ†é’Ÿæ‰«æ200ä¸‡+æ–‡ä»¶
            - ğŸ” å¼ºå¤§æœç´¢ï¼šæ”¯æŒæ¨¡ç³Šæœç´¢ã€æ­£åˆ™è¡¨è¾¾å¼
            - ğŸ’¾ ç¦»çº¿ä½¿ç”¨ï¼šä¸€æ¬¡æ‰«æï¼Œæ°¸ä¹…æœç´¢
            - ğŸ“¦ åŒæ¨¡å¼ï¼šå‘½ä»¤è¡Œå·¥å…· + GUIåº”ç”¨

            ### ğŸ“– æ–‡æ¡£
            - [README](https://github.com/${{ github.repository }}/blob/main/README.md)
            - [æ„å»ºè¯´æ˜](https://github.com/${{ github.repository }}/blob/main/BUILD.md)
            - [è´¡çŒ®æŒ‡å—](https://github.com/${{ github.repository }}/blob/main/CONTRIBUTING.md)

            ### ğŸ” æ ¡éªŒå’Œ
            ä¸‹è½½åè¯·éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼š
            ```bash
            shasum -a 256 -c checksums.txt
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
