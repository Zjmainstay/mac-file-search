name: Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v* æ ¼å¼çš„ tag æ—¶è§¦å‘ï¼ˆå¦‚ v0.1.0ï¼‰

permissions:
  contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  build-and-release:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Build CLI tool
        run: |
          make scanner
          # æ‰“åŒ…å‘½ä»¤è¡Œå·¥å…·
          tar -czf mac-file-search-${{ steps.version.outputs.VERSION }}-darwin-arm64.tar.gz mac-file-search
          # å¦‚æœéœ€è¦ x86_64 ç‰ˆæœ¬
          GOARCH=amd64 go build -o mac-file-search-amd64 main.go
          tar -czf mac-file-search-${{ steps.version.outputs.VERSION }}-darwin-amd64.tar.gz mac-file-search-amd64

      - name: Build GUI App
        run: |
          cd mac-search-app
          # æ­£å¸¸æ„å»ºï¼ˆåŒ…å«å‰ç«¯ç¼–è¯‘å’ŒåµŒå…¥ï¼‰
          wails build
          cd ..

          # ç§»é™¤éš”ç¦»å±æ€§ï¼Œé¿å… macOS Gatekeeper é˜»æ­¢
          xattr -cr "mac-search-app/build/bin/Macæ–‡ä»¶æœç´¢.app"

          # åˆ›å»º DMGï¼ˆå¯é€‰ï¼‰
          # brew install create-dmg
          # create-dmg --volname "Macæ–‡ä»¶æœç´¢" \
          #   --window-pos 200 120 --window-size 800 400 \
          #   --icon-size 100 --icon "Macæ–‡ä»¶æœç´¢.app" 200 190 \
          #   --hide-extension "Macæ–‡ä»¶æœç´¢.app" \
          #   --app-drop-link 600 185 \
          #   "mac-file-search-${{ steps.version.outputs.VERSION }}.dmg" \
          #   "mac-search-app/build/bin/"

          # ç›´æ¥æ‰“åŒ… .app ä¸º zipï¼ˆä½¿ç”¨ ditto ä¿ç•™æƒé™ï¼‰
          cd mac-search-app/build/bin
          ditto -c -k --keepParent "Macæ–‡ä»¶æœç´¢.app" "../../../mac-file-search-${{ steps.version.outputs.VERSION }}-app.zip"
          cd ../../..

      - name: Generate checksums
        run: |
          shasum -a 256 mac-file-search-${{ steps.version.outputs.VERSION }}-*.tar.gz > checksums.txt
          shasum -a 256 mac-file-search-${{ steps.version.outputs.VERSION }}-*.zip >> checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            mac-file-search-${{ steps.version.outputs.VERSION }}-darwin-arm64.tar.gz
            mac-file-search-${{ steps.version.outputs.VERSION }}-darwin-amd64.tar.gz
            mac-file-search-${{ steps.version.outputs.VERSION }}-app.zip
            checksums.txt
          body: |
            ## ğŸ‰ Mac File Search ${{ steps.version.outputs.VERSION }}

            ### âš¡ ä¸‹è½½

            #### GUI åº”ç”¨ï¼ˆæ¨èï¼‰
            - [Macæ–‡ä»¶æœç´¢.app (Universal)](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/mac-file-search-${{ steps.version.outputs.VERSION }}-app.zip) - å›¾å½¢ç•Œé¢åº”ç”¨

            #### å‘½ä»¤è¡Œå·¥å…·
            - [mac-file-search (ARM64)](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/mac-file-search-${{ steps.version.outputs.VERSION }}-darwin-arm64.tar.gz) - Apple Silicon (M1/M2/M3)
            - [mac-file-search (AMD64)](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/mac-file-search-${{ steps.version.outputs.VERSION }}-darwin-amd64.tar.gz) - Intel èŠ¯ç‰‡

            ### ğŸ“ å®‰è£…è¯´æ˜

            #### GUI åº”ç”¨

            **âš ï¸ é‡è¦ï¼šåº”ç”¨æœªç­¾åï¼Œå¿…é¡»å…ˆç§»é™¤ Gatekeeper éš”ç¦»å±æ€§**

            **æ–¹æ³• 1ï¼šä½¿ç”¨å®‰è£…è„šæœ¬ï¼ˆæ¨èï¼‰**
            ```bash
            curl -LO ${{ github.server_url }}/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/mac-file-search-${{ steps.version.outputs.VERSION }}-app.zip
            curl -LO ${{ github.server_url }}/${{ github.repository }}/raw/main/install.sh
            chmod +x install.sh
            ./install.sh mac-file-search-${{ steps.version.outputs.VERSION }}-app.zip
            ```

            **æ–¹æ³• 2ï¼šæ‰‹åŠ¨å®‰è£…**
            ```bash
            # 1. ä¸‹è½½å¹¶è§£å‹ ZIP
            # 2. ç§»é™¤éš”ç¦»å±æ€§ï¼ˆå¿…é¡»æ‰§è¡Œï¼‰ï¼š
            xattr -cr "Macæ–‡ä»¶æœç´¢.app"
            # 3. ç§»åŠ¨åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹ï¼š
            mv "Macæ–‡ä»¶æœç´¢.app" /Applications/
            ```

            #### å‘½ä»¤è¡Œå·¥å…·
            ```bash
            # ä¸‹è½½å¹¶è§£å‹
            tar -xzf mac-file-search-*-darwin-*.tar.gz

            # ç§»åŠ¨åˆ°ç³»ç»Ÿè·¯å¾„
            sudo mv mac-file-search /usr/local/bin/

            # éªŒè¯å®‰è£…
            mac-file-search --help
            ```

            ### âœ¨ ä¸»è¦åŠŸèƒ½
            - âš¡ æé€Ÿæ‰«æï¼š2åˆ†é’Ÿæ‰«æ200ä¸‡+æ–‡ä»¶
            - ğŸ” å¼ºå¤§æœç´¢ï¼šæ”¯æŒæ¨¡ç³Šæœç´¢ã€æ­£åˆ™è¡¨è¾¾å¼
            - ğŸ’¾ ç¦»çº¿ä½¿ç”¨ï¼šä¸€æ¬¡æ‰«æï¼Œæ°¸ä¹…æœç´¢
            - ğŸ“¦ åŒæ¨¡å¼ï¼šå‘½ä»¤è¡Œå·¥å…· + GUIåº”ç”¨

            ### ğŸ“– æ–‡æ¡£
            - [README](https://github.com/${{ github.repository }}/blob/main/README.md)
            - [æ„å»ºè¯´æ˜](https://github.com/${{ github.repository }}/blob/main/BUILD.md)
            - [è´¡çŒ®æŒ‡å—](https://github.com/${{ github.repository }}/blob/main/CONTRIBUTING.md)

            ### ğŸ” æ ¡éªŒå’Œ
            ä¸‹è½½åè¯·éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼š
            ```bash
            shasum -a 256 -c checksums.txt
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
